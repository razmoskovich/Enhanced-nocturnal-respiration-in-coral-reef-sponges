---
title: "nocturnal respiration"
author: "Raz"
date: "2/25/2021"
output:
  html_document:
    code_folding: hide
    theme: lumen
    toc: yes
    toc_depth: 2
    number_sections: yes
    df_print: paged
    toc_float:
      collapsed: no
      smooth_scroll: no
  word_document:
    toc: yes
    toc_depth: '2'
---

#packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(reshape2)
library(stringr)
library(data.table)
library(gridExtra)
library(hms)
library(lubridate)
library(cowplot)
library(stats)
library(multcomp)
#install.packages("googlesheets4")
library(googlesheets4)
library(epitools)
library(openair)
library(ggpubr)

#Rmarkdown assembly
library(rmdformats)
library(rmarkdown)
library(knitr)
library(formattable)
library(kableExtra)
library(tinytex) #if this installation does not work, read section below in RStudio 

```

# קוד שנכתב על ידי Dewey Dunnington על מנת לקבוע את הסקלה לבד בפנל של מספר איורים 
```{r}
Facet <- ggproto(
             
  init_scales = function(layout, x_scale = NULL, y_scale = NULL, params) {
    scales <- list()
    if (!is.null(x_scale)) {
      scales$x <- plyr::rlply(max(layout$SCALE_X), x_scale$clone())
    }
    if (!is.null(y_scale)) {
      scales$y <- plyr::rlply(max(layout$SCALE_Y), y_scale$clone())
    }
    scales
  },

)

scale_override <- function(which, scale) {
  if(!is.numeric(which) || (length(which) != 1) || (which %% 1 != 0)) {
    stop("which must be an integer of length 1")
  }
  
  if(is.null(scale$aesthetics) || !any(c("x", "y") %in% scale$aesthetics)) {
    stop("scale must be an x or y position scale")
  }
  
  structure(list(which = which, scale = scale), class = "scale_override")
}

CustomFacetWrap <- ggproto(
  "CustomFacetWrap", FacetWrap,
  init_scales = function(self, layout, x_scale = NULL, y_scale = NULL, params) {
    # make the initial x, y scales list
    scales <- ggproto_parent(FacetWrap, self)$init_scales(layout, x_scale, y_scale, params)
    
    if(is.null(params$scale_overrides)) return(scales)
    
    max_scale_x <- length(scales$x)
    max_scale_y <- length(scales$y)
    
    # ... do some modification of the scales$x and scales$y here based on params$scale_overrides
    for(scale_override in params$scale_overrides) {
      which <- scale_override$which
      scale <- scale_override$scale
      
      if("x" %in% scale$aesthetics) {
        if(!is.null(scales$x)) {
          if(which < 0 || which > max_scale_x) stop("Invalid index of x scale: ", which)
          scales$x[[which]] <- scale$clone()
        }
      } else if("y" %in% scale$aesthetics) {
        if(!is.null(scales$y)) {
          if(which < 0 || which > max_scale_y) stop("Invalid index of y scale: ", which)
          scales$y[[which]] <- scale$clone()
        }
      } else {
        stop("Invalid scale")
      }
    }
    
    # return scales
    scales
  }
)

facet_wrap_custom <- function(..., scale_overrides = NULL) {
  # take advantage of the sanitizing that happens in facet_wrap
  facet_super <- facet_wrap(...)
  
  # sanitize scale overrides
  if(inherits(scale_overrides, "scale_override")) {
    scale_overrides <- list(scale_overrides)
  } else if(!is.list(scale_overrides) || 
            !all(vapply(scale_overrides, inherits, "scale_override", FUN.VALUE = logical(1)))) {
    stop("scale_overrides must be a scale_override object or a list of scale_override objects")
  }
  
  facet_super$params$scale_overrides <- scale_overrides
  
  ggproto(NULL, CustomFacetWrap,
    shrink = facet_super$shrink,
    params = facet_super$params
  )
}





```

#איור ריכוז החמצן שנמדדו במי הסביבה ב-3 פתחי יציאה של הספוג טיונלה 
# Import data
```{r}
setwd("C:/Users/ASUS/Google Drive/Sponge/Data Analysis/respiration_files")
respiration_Thenoella_Data<-read.csv("Thenoella_swinohei.csv")

respiration_Thenoella_Data$Date_and_Time<-as.POSIXct(respiration_Thenoella_Data$Date_and_Time)
```


# ציור סדרת זמן של אוסקלה אם חלוקה לשעות אור יום וחושך
```{r, fig.width=10,fig.height=6}
respiration_Thenoella_plot<-ggplot(data=respiration_Thenoella_Data,aes(x=Date_and_Time))+
   annotate("rect", xmin = as.POSIXct("2018-07-29 18:00:00"), xmax = as.POSIXct("2018-07-30 06:00:00"),
        ymin = -Inf, ymax = Inf,fill ="#080706",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-07-30 18:00:00"), xmax = as.POSIXct("2018-07-31 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +

   annotate("rect", xmin = as.POSIXct("2018-07-29 15:02:00"), xmax = as.POSIXct("2018-07-29 18:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-07-30 06:00:00"), xmax = as.POSIXct("2018-07-30 18:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-07-31 06:00:00"), xmax = as.POSIXct("2018-07-31 08:28:51"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
  geom_point(aes(y=AMB),color ="#EE7600",size=0.5)+
 # geom_point(aes(y=Ex_11),color ="#B452CD",size=0.5)+
  geom_point(aes(y=Ex_12),color ="#634E41",size=0.5)+
 # geom_point(aes(y=Ex_13),color ="#FF4040",size=0.5)+
  labs(x = expression(""),y = expression(O[2] ~(mu*mol~L[p]^-1)))+
  coord_cartesian( ylim = c(0, 225))+
  scale_x_datetime(breaks = "6 hours")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_blank(),
        panel.background = element_blank(),
      axis.line = element_line(colour = "black"),
        axis.title=element_text(size=25),
      axis.text.y = element_text(size = 15),
      axis.text.x = element_text(size = 15,angle = 45, hjust = 1))

ggsave("C:/Users/ASUS/Google Drive/Sponge/Data Analysis/respiration_files/plot/respiration_Thenoella_plot.svg",width = 10, height = 6, dpi = 120)


respiration_Thenoella_plot 
```

#העלת קובץ שיעור הסרת חמצן
```{r}
Oxygen_removal_Data<-read.csv("Oxygen_removal_Data.csv")


Oxygen_removal_Data$Time<-as.hms(Oxygen_removal_Data$Time)
Oxygen_removal_Data$Date_and_Time<-as.POSIXct(Oxygen_removal_Data$Date_and_Time)
Oxygen_removal_Data$Date <- as.Date(Oxygen_removal_Data$Date,format= c("%d/%m/%Y"))
Oxygen_removal_Data$Taxa_cod<-as.factor(Oxygen_removal_Data$Taxa_cod)
Oxygen_removal_Data$Taxa<-as.factor(Oxygen_removal_Data$Taxa)
Oxygen_removal_Data$Date_and_Time<-as.POSIXct(Oxygen_removal_Data$Date_and_Time)
```


# סדרות זמן של 2 אוסקולה 
```{r, fig.width=15,fig.height=10}

Oxygen_removal_DataT<-Oxygen_removal_Data

                                             
Oxygen_removal_23<-Oxygen_removal_DataT %>% filter(Osc_cod =="23")


Oxygen_removal_23_plot<-ggplot(data=Oxygen_removal_23,aes(x=Oxygen_removal_23$Date_and_Time,y=Delta,fill=Oxygen_removal_23$light_darkness))+
 annotate("rect", xmin = as.POSIXct("2018-07-31 09:55:00"), xmax = as.POSIXct("2018-07-31 18:00:00"),
        ymin = -Inf, ymax = Inf,fill ="#FFFFFF",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-01 06:00:00"), xmax = as.POSIXct("2018-08-01 18:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
    annotate("rect", xmin = as.POSIXct("2018-08-02 06:00:00"), xmax = as.POSIXct("2018-08-02 09:01:00"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
  
  
   annotate("rect", xmin = as.POSIXct("2018-07-31 18:00:00"), xmax = as.POSIXct("2018-08-01 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-01 18:00:00"), xmax = as.POSIXct("2018-08-02 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +
   geom_point(aes(y=Delta),color ="black",size=0.5)+
 scale_x_datetime(breaks = "6 hours",labels = waiver(),date_labels = "%H:%M")+
   labs(x = expression(""),y = expression(Delta*O[2] ~(mu*mol~L[p]^-1)),fill="")+
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_blank(),
        panel.background = element_blank(),
      axis.line = element_line(colour = "black"),
      legend.position = "non",
        axis.title=element_text(size=30),
      axis.text.y = element_text(size = 30),
      axis.text.x = element_text(size = 30,angle = 45, hjust = 1))+
      coord_cartesian(ylim = c(-5,200))

ggsave("Oxygen_removal_23_plot.png", width = 15, height = 10, dpi = 120)


Oxygen_removal_23_plot



Oxygen_removal_32<-Oxygen_removal_DataT %>% filter(Osc_cod =="32")


Oxygen_removal_32_plot<-ggplot(data=Oxygen_removal_32,aes(x=Oxygen_removal_32$Date_and_Time,y=Delta,fill=Oxygen_removal_32$light_darkness))+
  annotate("rect", xmin = as.POSIXct("2018-08-02 10:31:00"), xmax = as.POSIXct("2018-08-02 18:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#FFFFFF",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-03 06:00:00"), xmax = as.POSIXct("2018-08-03 18:00:00"),
        ymin = -Inf, ymax = Inf,fill =  "#FFFFFF",
        alpha = 0.2) +
    annotate("rect", xmin = as.POSIXct("2018-08-04 06:00:00"), xmax = as.POSIXct("2018-08-04 18:00:00"),
        ymin = -Inf, ymax = Inf,fill =  "#FFFFFF",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-05 06:00:00"), xmax = as.POSIXct("2018-08-05 09:19:00"),
        ymin = -Inf, ymax = Inf,fill =  "#FFFFFF",
        alpha = 0.2) +
     annotate("rect", xmin = as.POSIXct("2018-08-02 18:00:00"), xmax = as.POSIXct("2018-08-03 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-03 18:00:00"), xmax = as.POSIXct("2018-08-04 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +
   annotate("rect", xmin = as.POSIXct("2018-08-04 18:00:00"), xmax = as.POSIXct("2018-08-05 06:00:00"),
        ymin = -Inf, ymax = Inf,fill = "#080706",
        alpha = 0.2) +
   geom_point(aes(y=Delta),color ="black",size=0.5)+
 scale_x_datetime(breaks = "6 hours",labels = waiver(),date_labels = "%H:%M")+
   labs(x = expression(""),y = expression(Delta*O[2] ~(mu*mol~L[p]^-1)),fill="")+
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_blank(),
        panel.background = element_blank(),
      axis.line = element_line(colour = "black"),
      legend.position = "non",
        axis.title=element_text(size=30),
      axis.text.y = element_text(size = 30),
      axis.text.x = element_text(size = 30,angle = 45, hjust = 1))+
   coord_cartesian(ylim = c(-5,200))

ggsave("Oxygen_removal_32_plot.png", width = 15, height = 10, dpi = 120)


Oxygen_removal_32_plot

```

#פאנל 1 עם 2 סדרות זמן של 2 אוסקולה
```{r, fig.width=20,fig.height=7,warning=FALSE}

Oxygen_removal_2plot<-ggarrange(Oxygen_removal_32_plot, Oxygen_removal_23_plot, 
          labels = c("A", "B"),font.label = list(size =30),
          ncol = 2, nrow = 1)

ggsave("Oxygen_removal_2plot.png",width = 20, height = 7, dpi = 120)

Oxygen_removal_2plot
```
#איורים של דפוס יממי לפי מינים 

```{r, fig.width=20,fig.height=21}

Dailycycles<-Oxygen_removal_Data


Dailycycles$rounddatetime<-round_date(Dailycycles$Date_and_Time, "3 hour")
Dailycycles$roundtime<-substr(Dailycycles$rounddatetime,12,19)
Dailycycles$roundtime<-as.hms(Dailycycles$roundtime)

summariOsc_Dailycycles<-Dailycycles%>% 
  group_by(Taxa,Taxa_cod,Osc_cod,roundtime) %>% 
  summarise_at(vars(Delta),funs(mean,median, sd, n()))

colnames(summariOsc_Dailycycles)[colnames(summariOsc_Dailycycles)=="mean"] <- "mean_delta"



summari_Dailycycles<-summariOsc_Dailycycles%>% 
  group_by(Taxa,Taxa_cod,roundtime) %>% 
  summarise_at(vars(mean_delta),funs(mean,median, sd, n()))

summari_Dailycycles$ci =summari_Dailycycles$sd/sqrt(summari_Dailycycles$n)*
                                                         qt(p=0.975,df=(summari_Dailycycles$n)-1)

summari_Dailycycles$roundtime<-substr(summari_Dailycycles$roundtime, 1, 5)
summariOsc_Dailycycles$roundtime<-substr(summariOsc_Dailycycles$roundtime, 1, 5)
summari_Dailycycles$roundtime<-as.character(summari_Dailycycles$roundtime)
summariOsc_Dailycycles$roundtime<-as.character(summariOsc_Dailycycles$roundtime)
summari_Dailycycles$Taxa_cod<-
                  factor(summari_Dailycycles$Taxa_cod,
                                                      levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi","C.siphonella"))
summariOsc_Dailycycles$Taxa_cod<-
                  factor(summariOsc_Dailycycles$Taxa_cod,
                                                      levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi","C.siphonella"))


summari_Dailycycles_boxplot <-ggplot(data=summariOsc_Dailycycles,aes(x=roundtime, y=mean_delta))+
                                   annotate("rect", xmin =  -Inf, xmax = "06:00",
                                                     ymin = -Inf, ymax = Inf,fill ="#080706", alpha = 0.2) +
                                    annotate("rect", xmin = "06:00", xmax = "18:00",
                                                     ymin = -Inf, ymax = Inf,fill = "#FFFFFF",alpha = 0.2) +
                                    annotate("rect", xmin = "18:00", xmax = Inf,
                                                     ymin = -Inf, ymax = Inf,fill = "#080706",alpha = 0.2) +
  # facet_grid(~Taxa_cod~.,scales='free')+
  facet_wrap( ~ Taxa_cod, ncol=3,scales='free') +
   facet_wrap_custom(.~Taxa_cod,ncol=3,scales='free',  scale_overrides = list(scale_override(1, scale_y_continuous(limits = c(0, 70))),
                                                                       scale_override(2, scale_y_continuous(limits = c(0, 30))),
                                                                       scale_override(3, scale_y_continuous(limits = c(0, 15))),
                                                                       scale_override(7, scale_y_continuous(limits = c(0, 4)))))+
  geom_boxplot(outlier.shape = NA, color = "black",size=1)+
  geom_line(data = summari_Dailycycles, mapping = aes(x = roundtime, y = median, group=1),color = "black",size=1)+
      labs(x = expression(""),
                                        y = expression(Delta*O[2] ~(mu*mol~L[p]^-1)),color="")+
                             theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                                    panel.border = element_rect(fill = NA, color = "black"),
                                    panel.background = element_blank(), axis.line = element_line(colour = "black"),
                                    strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
                                    legend.key = element_rect(fill = "white", color = NA,size=30),
                                    legend.title = element_text( size =20),
                                    legend.position = "none",
                                    legend.text = element_text(size=30),
                                    legend.key.size = unit(1.5, "cm"),
                                    legend.key.width = unit(1.5,"cm"),
                                    axis.title.y=element_text(size=35),
                                    axis.title.x=element_text(size=30),
                                    axis.text.y = element_text(size=20),
                                    axis.text.x = element_text(size = 20,angle = 45, hjust = 1),
                                    strip.text= element_text(size =20,face="italic"))
                                   # coord_cartesian(ylim = c(0,30))
ggsave("summari_Dailycycles_boxplot.png",width = 20, height = 21, dpi = 120)
summari_Dailycycles_boxplot 
```

#סידור הנתונים לפי שעות אור וחושך

```{r}
Oxygen_removal_Data<-read.csv("Oxygen_removal_Data.csv") 
Sunrise_Sunset_Data<-read.csv("Sunrise_Sunset_11072019.csv") 

Oxygen_removal_Data$Date <- as.Date(Oxygen_removal_Data$Date,format= c("%d/%m/%Y"))
Sunrise_Sunset_Data$Date <- as.Date(Sunrise_Sunset_Data$Date,format= c("%d/%m/%Y"))
Sunrise_Sunset_respiration_Data <- merge(Oxygen_removal_Data, Sunrise_Sunset_Data,by="Date")

Sunrise_Sunset_respiration_Data$Time<-as.character(Sunrise_Sunset_respiration_Data$Time)
Sunrise_Sunset_respiration_Data$Time <- as.hms(Sunrise_Sunset_respiration_Data$Time)

Sunrise_Sunset_respiration_Data$Sunrise<-as.character(Sunrise_Sunset_respiration_Data$Sunrise)
Sunrise_Sunset_respiration_Data$Sunrise <- as.hms(Sunrise_Sunset_respiration_Data$Sunrise)
Sunrise_Sunset_respiration_Data$Sunset<-as.character(Sunrise_Sunset_respiration_Data$Sunset)
Sunrise_Sunset_respiration_Data$Sunset <- as.hms(Sunrise_Sunset_respiration_Data$Sunset)
Sunrise_Sunset_respiration_Data$Twilight_Sunrise<-as.character(Sunrise_Sunset_respiration_Data$Twilight_Sunrise)
Sunrise_Sunset_respiration_Data$Twilight_Sunrise <- as.hms(Sunrise_Sunset_respiration_Data$Twilight_Sunrise)
Sunrise_Sunset_respiration_Data$Twilight_Sunset<-as.character(Sunrise_Sunset_respiration_Data$Twilight_Sunset)
Sunrise_Sunset_respiration_Data$Twilight_Sunset <- as.hms(Sunrise_Sunset_respiration_Data$Twilight_Sunset)



Sunrise_Sunset_respiration_Data $light_darkness <-ifelse(Sunrise_Sunset_respiration_Data $Sunset >=       
                                                      Sunrise_Sunset_respiration_Data $Time &
                                                 Sunrise_Sunset_respiration_Data $Sunrise <=
                                                       Sunrise_Sunset_respiration_Data $Time,"light",
                                                 ifelse(Sunrise_Sunset_respiration_Data $Twilight_Sunset <=
                                                      Sunrise_Sunset_respiration_Data $Time ,"darkness",
                                                ifelse(Sunrise_Sunset_respiration_Data $Twilight_Sunrise >=
                                                      Sunrise_Sunset_respiration_Data $Time ,"darkness",
                                               ifelse(Sunrise_Sunset_respiration_Data $Sunset <=
                                                       Sunrise_Sunset_respiration_Data $Time&
                                                  Sunrise_Sunset_respiration_Data $Twilight_Sunset >=
                                                       Sunrise_Sunset_respiration_Data $Time,"Twilight",
                                                  ifelse(Sunrise_Sunset_respiration_Data $Twilight_Sunrise <=
                                                       Sunrise_Sunset_respiration_Data $Time&
                                                  Sunrise_Sunset_respiration_Data $Sunrise >=
                                                       Sunrise_Sunset_respiration_Data $Time,"Twilight", "NA")))))

Sunrise_Sunset_respiration_Data$Taxa<-as.factor(Sunrise_Sunset_respiration_Data$Taxa)
Sunrise_Sunset_respiration_Data$Taxa_cod<-as.factor(Sunrise_Sunset_respiration_Data$Taxa_cod)

write.csv(Sunrise_Sunset_respiration_Data , "Sunrise_Sunset_respiration_Data.csv")
                                                 
```

#נתונים סטטיסטים להסרת חמצן לפי שעות אור וחושך
```{r}

Sunrise_Sunset_Oxygen_removal_Data<-read.csv("Sunrise_Sunset_respiration_Data.csv") 

Sunrise_Sunset_Oxygen_removal_Data$Time<-as.hms(Sunrise_Sunset_Oxygen_removal_Data$Time)
Sunrise_Sunset_Oxygen_removal_Data$Date_and_Time<-as.POSIXct(Sunrise_Sunset_Oxygen_removal_Data$Date_and_Time)
Sunrise_Sunset_Oxygen_removal_Data$Date <- as.Date(Sunrise_Sunset_Oxygen_removal_Data$Date,format= c("%d/%m/%Y"))
Sunrise_Sunset_Oxygen_removal_Data$Taxa_cod<-as.factor(Sunrise_Sunset_Oxygen_removal_Data$Taxa_cod)
Sunrise_Sunset_Oxygen_removal_Data$Taxa<-as.factor(Sunrise_Sunset_Oxygen_removal_Data$Taxa)
Sunrise_Sunset_Oxygen_removal_Data$light_darkness<-as.factor(Sunrise_Sunset_Oxygen_removal_Data$light_darkness)
Sunrise_Sunset_Oxygen_removal_Data<-Sunrise_Sunset_Oxygen_removal_Data %>% filter(light_darkness !="Twilight")

Sunrise_Sunset_osc_Data  =Sunrise_Sunset_Oxygen_removal_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,Osc_cod,light_darkness) %>%
  summarise_at(vars(Delta),funs(mean,median, sd, n()))

Sunrise_Sunset_osc_Data$ci=Sunrise_Sunset_osc_Data$sd/
                                       sqrt(Sunrise_Sunset_osc_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_osc_Data$n)-1)
write.csv(Sunrise_Sunset_osc_Data , "Sunrise_Sunset_osc_Data.csv")
colnames(Sunrise_Sunset_osc_Data)[colnames(Sunrise_Sunset_osc_Data)=="mean"] <- "Oxygen_removal"

Sunrise_Sunset_sponge_Data  =Sunrise_Sunset_osc_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,light_darkness) %>%
  summarise_at(vars(Oxygen_removal),funs(mean,median, sd, n()))

Sunrise_Sunset_sponge_Data$ci=Sunrise_Sunset_sponge_Data$sd/
                                       sqrt(Sunrise_Sunset_sponge_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_sponge_Data$n)-1)

write.csv(Sunrise_Sunset_sponge_Data , "Sunrise_Sunset_sponge_Data.csv")
colnames(Sunrise_Sunset_sponge_Data)[colnames(Sunrise_Sunset_sponge_Data)=="mean"] <- "Oxygen_removal"

Sunrise_Sunset_taxa_Data  =Sunrise_Sunset_sponge_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,light_darkness) %>%
  summarise_at(vars(Oxygen_removal),funs(mean,median, sd, n()))

Sunrise_Sunset_taxa_Data$ci=Sunrise_Sunset_taxa_Data$sd/
                                       sqrt(Sunrise_Sunset_taxa_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_taxa_Data$n)-1)
write.csv(Sunrise_Sunset_taxa_Data , "Sunrise_Sunset_taxa_Data.csv")
colnames(Sunrise_Sunset_taxa_Data)[colnames(Sunrise_Sunset_taxa_Data)=="mean"] <- "Oxygen_removal"



```


#פרמוטציה על פי אנובה להבדלים בין מינים,  ובין אור לחושך
```{r}
#Fit an Analysis of Variance Model
aov_Oxygen_removal <- aov(Oxygen_removal ~ Taxa_cod*light_darkness, data=Sunrise_Sunset_osc_Data)
#ANOVA data summary table
obs_aov=summary(aov_Oxygen_removal)
#Save the observed F value
obs_f = obs_aov[[1]]$`F value`[1:3]
#Number of times to run
n=1000
#Create a vector for each variable with the number of runs
taxa_rand_f = 1:n
lightDark_rand_f = 1:n
interaction_rand_f = 1:n

#A loop in which the oxygen removal is mixed n times and a new F is found for each variable
for (i in 1:n) {
  rand_data =Sunrise_Sunset_osc_Data
  rand_data$Oxygen_removal = sample(Sunrise_Sunset_osc_Data$Oxygen_removal, 
                                       size = length(Sunrise_Sunset_osc_Data$Oxygen_removal),replace = F)
  r_aov = aov(Oxygen_removal~ Taxa_cod*light_darkness, data=rand_data)
  rand_aov=summary(r_aov)
  r_f = rand_aov[[1]]$`F value`[1:3]
  taxa_rand_f[i] = r_f[1]
  lightDark_rand_f[i] = r_f[2]
  interaction_rand_f[i] = r_f[3]
}
#Drawing a graph for each variable
hist(taxa_rand_f, xlim = c(0,obs_f[1])*1.5)
abline(v = obs_f[1])
hist(lightDark_rand_f)
abline(v = obs_f[2])
hist(interaction_rand_f)
abline(v=obs_f[3])

#Calculation and presentation of P value for each variable
P_value_taxa<-(sum(taxa_rand_f>obs_f[1])+sum(taxa_rand_f<-obs_f[1]))/1000
P_value_lightDark<-(sum(lightDark_rand_f>obs_f[2])+sum(lightDark_rand_f<-obs_f[2]))/1000
P_value_interaction<-sum(interaction_rand_f>obs_f[3]+sum(interaction_rand_f<-obs_f[3]))/1000
P_value_taxa
P_value_lightDark
P_value_interaction


summary(glht(aov_Oxygen_removal))
TukeyHSD(aov_Oxygen_removal)


```



#איורים של הסרת חמצן ביום ובלילה לפי אוסקולה בכל מין
```{r, fig.width=20,fig.height=15}


Sunrise_Sunset_Oxygen_removal_Data$Taxa_cod<- factor(Sunrise_Sunset_Oxygen_removal_Data$Taxa_cod,levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus","C.siphonella",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi"))
Sunrise_Sunset_Oxygen_removal_Data$Osc_cod<-as.factor(Sunrise_Sunset_Oxygen_removal_Data$Osc_cod)


Sunrise_Sunset_osc_boxplot<-ggplot(Sunrise_Sunset_Oxygen_removal_Data,aes(x=Osc_cod,y=Delta,fill = light_darkness))+
  geom_boxplot(outlier.shape = NA)+
      facet_wrap_custom(.~Taxa_cod,scales='free',  scale_overrides = list(scale_override(3, scale_y_continuous(limits = c(0, 20))),
                                                                       scale_override(4, scale_y_continuous(limits = c(0, 10))),
                                                                       scale_override(5, scale_y_continuous(limits = c(0, 10))),
                                                                       scale_override(6, scale_y_continuous(limits = c(0, 10))),
                                                                       scale_override(7, scale_y_continuous(limits = c(0, 10)))))+
  stat_summary(fun.y = mean, geom = "point", size=2, shape=4,
               position = position_dodge(width = .75))+
  labs(x ="" ,y = expression(Delta*O[2] ~(mu*mol~L[p]^-1)),fill= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =20),
       legend.text = element_text(size=30),
      legend.key.size = unit(1.5, "cm"),
       legend.key.width = unit(1.5,"cm"),
      legend.position="bottom",
         panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=40),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=35),
      axis.text.x = element_text(size=20),
      strip.text= element_text(size =30,face="italic"))+
  scale_fill_manual(values=c("#454545", "#FFA500"))

ggsave("Sunrise_Sunset_osc_boxplot.SVG",width = 25, height =15, dpi = 120)

Sunrise_Sunset_osc_boxplot

```


#איור של הסרת החמצן בכל מין 

```{r, fig.width=20,fig.height=15}


Sunrise_Sunset_sponge_Data$Taxa_cod<- factor(Sunrise_Sunset_sponge_Data$Taxa_cod,levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus","C.siphonella",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi"))

Sunrise_Sunset_spong_Data_boxplot<-ggplot(Sunrise_Sunset_sponge_Data,
                                                      aes(x=Taxa_cod,y=Oxygen_removal,
                                                                            fill = light_darkness))+
  geom_boxplot(outlier.shape = NA)+
  facet_grid(.~Taxa_cod,scales='free')+
  stat_summary(fun.y = mean, geom = "point", size=2, shape=4,
               position = position_dodge(width = .75))+
  labs(x ="" ,y = expression(Delta*O[2] ~(mu*mol~L[p]^-1)),fill= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =20),
       legend.text = element_text(size=30),
      legend.key.size = unit(1.5, "cm"),
       legend.key.width = unit(1.5,"cm"),
      legend.position = c(0.93, 0.9) ,
             panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=40),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=35),
      axis.text.x = element_blank(),
      strip.text= element_text(size =30,face="italic"))+
  scale_fill_manual(values=c("#454545", "#FFA500"))


ggsave("Sunrise_Sunset_spong_Data_boxplot.png",width = 25, height =15, dpi = 120)

Sunrise_Sunset_spong_Data_boxplot

```


#העלת קובת קצב שאיבה 
```{r}

Sunrise_Sunset_DFS_Data<-read.csv("Sunrise_Sunset_DFS_Data.csv")

Sunrise_Sunset_DFS_Data$Date<-as.Date(Sunrise_Sunset_DFS_Data$Date,format= c("%d/%m/%Y"))
Sunrise_Sunset_DFS_Data$Time<-as.hms(Sunrise_Sunset_DFS_Data$Time)
Sunrise_Sunset_DFS_Data$Date_Time<-as.POSIXct(Sunrise_Sunset_DFS_Data$Date_Time)

Sunrise_Sunset_DFS_Data$HMA_LMA<-as.factor(Sunrise_Sunset_DFS_Data$HMA_LMA)
Sunrise_Sunset_DFS_Data$Taxa<-as.factor(Sunrise_Sunset_DFS_Data$Taxa)
Sunrise_Sunset_DFS_Data$Taxa_cod<-as.factor(Sunrise_Sunset_DFS_Data$Taxa_cod)
Sunrise_Sunset_DFS_Data$Osc_cod<-as.factor(Sunrise_Sunset_DFS_Data$Osc_cod)
Sunrise_Sunset_DFS_Data$Sponge_Cod<-as.factor(Sunrise_Sunset_DFS_Data$Sponge_Cod)

```

#סטטיסטיקה של קצב שאיבה יום ולילה
```{r}

Sunrise_Sunset_run_Data =Sunrise_Sunset_DFS_Data%>% 
  group_by(Date,Time,Date_Time,HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,Osc_cod,DFS_run,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,median, sd, n()))

Sunrise_Sunset_run_Data$ci=Sunrise_Sunset_run_Data$sd/
                                       sqrt(Sunrise_Sunset_run_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_run_Data$n)-1)
#write.csv(Sunrise_Sunset_run_Data , "Sunrise_Sunset_run_Data.csv")
colnames(Sunrise_Sunset_run_Data)[colnames(Sunrise_Sunset_run_Data)=="mean"] <- "Pumping_rate_L_hr"


Date_Time_Osc_cod_Data =Sunrise_Sunset_run_Data%>% 
  group_by(Date,Time,Date_Time,HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,Osc_cod,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,median, sd, n()))

Date_Time_Osc_cod_Data$ci=Date_Time_Osc_cod_Data$sd/
                                       sqrt(Date_Time_Osc_cod_Data$n)*
                                      qt(p = 0.975, df = (Date_Time_Osc_cod_Data$n)-1)
write.csv(Date_Time_Osc_cod_Data , "Date_Time_Osc_cod_Data.csv")
colnames(Date_Time_Osc_cod_Data)[colnames(Date_Time_Osc_cod_Data)=="mean"] <- "Pumping_rate_L_hr"

Sunrise_Sunset_Osc_cod_Data =Sunrise_Sunset_run_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,Osc_cod,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,median, sd, n()))

Sunrise_Sunset_Osc_cod_Data$ci=Sunrise_Sunset_Osc_cod_Data$sd/
                                       sqrt(Sunrise_Sunset_Osc_cod_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_Osc_cod_Data$n)-1)
write.csv(Sunrise_Sunset_Osc_cod_Data , "Sunrise_Sunset_Osc_cod_Data.csv")

colnames(Sunrise_Sunset_Osc_cod_Data)[colnames(Sunrise_Sunset_Osc_cod_Data)=="mean"] <- "Pumping_rate_L_hr"


run_Sunrise_Sunset_DFS_Data  = Sunrise_Sunset_DFS_Data  %>% 
  group_by(Taxa,Taxa_cod,HMA_LMA,Osc_cod,Sponge_Cod,Dive_number,DFS_run,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,n()))

sum_Dive_Sunrise_Sunset_DFS_Data = run_Sunrise_Sunset_DFS_Data  %>% 
  group_by(Taxa,Taxa_cod,HMA_LMA,Sponge_Cod,Dive_number,light_darkness) %>%
  summarise_at(vars(mean),funs(sum,n()))

colnames(sum_Dive_Sunrise_Sunset_DFS_Data)[colnames(sum_Dive_Sunrise_Sunset_DFS_Data)=="sum"] <- "Pumping_rate_L_hr"

sum_Dive_Sunrise_Sunset_DFS_Data<-arrange(sum_Dive_Sunrise_Sunset_DFS_Data,Sponge_Cod)

rownamber<-c(58:64)
for (i in 1:length(rownamber)){
sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr[sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr==
               sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr[[rownamber[i]]]]<-
                (sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr[[rownamber[i]]])+
               ((sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr[[rownamber[i]]]/4)*8)
}

Sunrise_Sunset_Sponge_Data =sum_Dive_Sunrise_Sunset_DFS_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,median, sd, n()))

Sunrise_Sunset_Sponge_Data$ci=Sunrise_Sunset_Sponge_Data$sd/
                                       sqrt(Sunrise_Sunset_Sponge_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_Sponge_Data$n)-1)

write.csv(Sunrise_Sunset_Sponge_cod_Data , "Sunrise_Sunset_Sponge_cod_Data.csv")

colnames(Sunrise_Sunset_Sponge_Data)[colnames(Sunrise_Sunset_Sponge_Data)=="mean"] <- "Pumping_rate_L_hr"


Sunrise_Sunset_Taxa_Data =Sunrise_Sunset_Sponge_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,light_darkness) %>%
  summarise_at(vars(Pumping_rate_L_hr),funs(mean,median, sd, n()))

Sunrise_Sunset_Taxa_Data$ci=Sunrise_Sunset_Taxa_Data$sd/
                                       sqrt(Sunrise_Sunset_Taxa_Data$n)*
                                      qt(p = 0.975, df = (Sunrise_Sunset_Taxa_Data$n)-1)

write.csv(Sunrise_Sunset_Taxa_Data , "Sunrise_Sunset_Taxa_Data.csv")

colnames(Sunrise_Sunset_Taxa_Data)[colnames(Sunrise_Sunset_Taxa_Data)=="mean"] <- "Pumping_rate_L_hr"

```


#גרף קופסרות עם קצב השאיבה לכל מין ביום ובלילה  

```{r, fig.width=20,fig.height=15}

sum_Dive_Sunrise_Sunset_DFS_Data$Taxa_cod<- factor(sum_Dive_Sunrise_Sunset_DFS_Data$Taxa_cod,
                                                   levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus","C.siphonella",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi"))


sum_Dive_Sunrise_Sunset_DFS_Data$Taxa <- factor(sum_Dive_Sunrise_Sunset_DFS_Data$Taxa,
                                                levels=c("Theonella swinhoei","Diacarnus erythraeanus",
                                                               "Suberites clavatus","Callyspongia siphonella",
                                                               "Mycale fistulifera","Crella cyathophora",
                                                               "Niphates rowi"))

Sunrise_Sunset_run_DFS_Taxa_boxplot<-ggplot(sum_Dive_Sunrise_Sunset_DFS_Data,aes(x=Taxa_cod,y=Pumping_rate_L_hr,
                                                                            fill = light_darkness))+
  geom_boxplot(outlier.shape = NA)+
  facet_grid(.~Taxa_cod,scales='free')+
  stat_summary(fun.y = mean, geom = "point", size=2, shape=4,
               position = position_dodge(width = .75))+
  labs(x ="" ,y = expression("Pumping rate"~ ~(L[p]~ hr^-1)),fill= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =20),
       legend.text = element_text(size=30),
        legend.position = c(0.93, 0.9),
      legend.key.size = unit(1.2, "cm"),
       legend.key.width = unit(1.2,"cm"),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=35),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=30),
      axis.text.x = element_blank(),
      strip.text= element_text(size =28,face="italic"))+
  scale_fill_manual(values=c("#454545", "#FFA500", "#1C86EE"))
       coord_trans(y="log10")

#ggsave("Sunrise_Sunset_run_DFS_Taxa_boxplot.png",width = 20, height = 12, dpi = 120)

Sunrise_Sunset_run_DFS_Taxa_boxplot

```
 
# קצב השאיבה בכל מין ביום ובלילה
```{r, fig.width=20,fig.height=15}


Sunrise_Sunset_Osc_cod_Data$Taxa <- factor(Sunrise_Sunset_Osc_cod_Data$Taxa,
                                           levels=c("Theonella swinhoei","Diacarnus erythraeanus",
                                                               "Suberites clavatus","Callyspongia siphonella",
                                                               "Mycale fistulifera","Crella cyathophora",
                                                               "Niphates rowi"))

Sunrise_Sunset_Osc_cod_Data$Taxa_cod<- factor(Sunrise_Sunset_Osc_cod_Data$Taxa_cod,
                                                   levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus","C.siphonella",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi"))
Sunrise_Sunset_Osc_cod_Data_plot<-ggplot(Sunrise_Sunset_Osc_cod_Data,aes(x=Osc_cod,
                                                        y=Pumping_rate_L_hr,colour = light_darkness))+
  geom_point(size=4)+
  facet_grid(.~Taxa_cod,scales='free')+
  labs(x ="" ,y = expression(OFR ~~("L"~ hr^-1)),colour= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =15),
       legend.text = element_text(size=20),
      legend.key.size = unit(1.5, "cm"),
       legend.key.width = unit(1.5,"cm"),
      legend.position = c(0.93, 0.9) ,
         panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=40),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=35),
      axis.text.x = element_text(size=20),
      strip.text= element_text(size =25,face="italic"))+
   scale_color_manual(values=c("#000000", "#FFA500"))+
   geom_errorbar(aes(ymin=Sunrise_Sunset_Osc_cod_Data$Pumping_rate_L_hr+Sunrise_Sunset_Osc_cod_Data$ci,
                    ymax=Sunrise_Sunset_Osc_cod_Data$Pumping_rate_L_hr-Sunrise_Sunset_Osc_cod_Data$ci))


Sunrise_Sunset_Osc_cod_Data_plot



```

#חלוקה לקטגוריות זמן של 3 שעות את נתונים קצב השאיבה וחישוב אחוז מהמקסיום שאיבה בכל אוסקולה
```{r, fig.width=20,fig.height=15}



OFR_categorize_Time_Data<-Date_Time_Osc_cod_Data


OFR_categorize_Time_Data$ID<-paste(str_sub(OFR_categorize_Time_Data$Date_Time,12,-7))
##Definition of the new column as numeric
OFR_categorize_Time_Data$ID<-as.numeric(OFR_categorize_Time_Data$ID)

#Define categories by the new column
setDT(OFR_categorize_Time_Data)[ID <2.9, Timegroup := "00:00-03:00"]
OFR_categorize_Time_Data[ID >2.9 & ID <5.9, Timegroup := "03:00-06:00"]
OFR_categorize_Time_Data[ID >5.9 & ID <8.9, Timegroup := "06:00-09:00"]
OFR_categorize_Time_Data[ID >8.9 & ID <11.9, Timegroup := "09:00-12:00"]
OFR_categorize_Time_Data[ID >11.9 & ID <14.9, Timegroup := "12:00-15:00"]
OFR_categorize_Time_Data[ID >14.9 & ID <17.9, Timegroup := "15:00-18:00"]
OFR_categorize_Time_Data[ID >17.9 & ID <20.9, Timegroup := "18:00-21:00"]
OFR_categorize_Time_Data[ID >20.9 , Timegroup := "21:00-00:00"]



PerMax_Data<-OFR_categorize_Time_Data%>% group_by(Osc_cod) %>% mutate(PerMax= (Pumping_rate_L_hr/max(Pumping_rate_L_hr))*100)

```

# פאנלים אם אחוז מקצב השאיבה המקסמלי בכל אוסקולה

```{r, fig.width=20,fig.height=15}
PerMax_Data$Taxa_cod<- factor(PerMax_Data$Taxa_cod,
                                                   levels=c("T.swinhoei","D.erythraeanus",
                                                               "S.clavatus","C.siphonella",
                                                               "M.fistulifera","C.cyathophora",
                                                               "N.rowi"))

PerMax_Data_plot<-ggplot(PerMax_Data,aes(x=Timegroup,y=PerMax,fill=Osc_cod))+
                                                                            
  geom_boxplot(outlier.shape = NA)+
 facet_wrap(.~Taxa_cod,scales='free')+
  labs(x ="" ,y = expression("Percent from Max"~("%")),fill= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =20),
       legend.text = element_text(size=30),
      legend.position = 'none',
          legend.key.size = unit(1.2, "cm"),
       legend.key.width = unit(1.2,"cm"),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=35),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=30),
      axis.text.x = element_text(size=15,angle = 45, hjust = 1),
      strip.text= element_text(size =28,face="italic"))
    
ggsave("PerMax_Data_plot.png",width = 20, height = 15, dpi = 120)

PerMax_Data_plot


Summaty_PerMax_Data =PerMax_Data%>% 
  group_by(HMA_LMA,Taxa,Taxa_cod,Sponge_Cod,Osc_cod,Timegroup) %>%
  summarise_at(vars(PerMax),funs(mean,median, sd, n()))

Summaty_PerMax_Data$ci=Summaty_PerMax_Data$sd/
                                       sqrt(Summaty_PerMax_Data$n)*
                                      qt(p = 0.975, df = (Summaty_PerMax_Data$n)-1)

colnames(Summaty_PerMax_Data)[colnames(Summaty_PerMax_Data)=="mean"] <- "PerMax"

Summaty_PerMax_Data_plot<-ggplot(Summaty_PerMax_Data,aes(x=Timegroup,
                                                        y=PerMax,colour = Osc_cod))+
  geom_point(size=4)+
 facet_wrap(.~Taxa_cod,scales='free')+
  labs(x ="" ,y = expression("Percent from Max"~("%")),colour= "")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black"),
       legend.key = element_rect(fill = "white", color = NA,size=30),
       legend.title = element_text( size =15),
       legend.text = element_text(size=20),
      legend.key.size = unit(1.5, "cm"),
       legend.key.width = unit(1.5,"cm"),
     legend.position = 'none',
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        strip.background = element_rect(fill="white",color="black", size=1.5, linetype="solid"),
        axis.title.y=element_text(size=40),
      axis.title.x=element_blank(),
      axis.text.y = element_text(size=35),
      axis.text.x = element_text(size=15,angle = 45, hjust = 1),
      strip.text= element_text(size =25,face="italic"))+
   geom_errorbar(aes(ymin=Summaty_PerMax_Data$PerMax+Summaty_PerMax_Data$ci,
                    ymax=Summaty_PerMax_Data$PerMax-Summaty_PerMax_Data$ci))+
  coord_cartesian(ylim = c(0,100))

ggsave("Summaty_PerMax_Data_plot.png",width = 20, height = 15, dpi = 120)
  
Summaty_PerMax_Data_plot
```
#פרמוטציה על פי אנובה לקצב השאיבה בין מינים ובין אור וחושך
```{r}
sum_Dive_Sunrise_Sunset_DFS_Data
aov2_Pumping_rate <- aov(Pumping_rate_L_hr~ Taxa_cod*light_darkness, data=sum_Dive_Sunrise_Sunset_DFS_Data)
obs_aov2=summary(aov2_Pumping_rate)
obs_f = obs_aov2[[1]]$`F value`[1:3]
n=10000

taxa_rand_f = 1:n
lightDark_rand_f = 1:n
interaction_rand_f = 1:n

for (i in 1:n) {
  rand_data = sum_Dive_Sunrise_Sunset_DFS_Data
  rand_data$Pumping_rate_L_hr = sample(sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr, 
                                       size = length(sum_Dive_Sunrise_Sunset_DFS_Data$Pumping_rate_L_hr),replace = F)
  r_aov = aov(Pumping_rate_L_hr~ Taxa_cod*light_darkness, data=rand_data)
  rand_aov=summary(r_aov)
  r_f = rand_aov[[1]]$`F value`[1:3]
  taxa_rand_f[i] = r_f[1]
  lightDark_rand_f[i] = r_f[2]
  interaction_rand_f[i] = r_f[3]
}
hist(taxa_rand_f, xlim = c(0,obs_f[1])*1.5)
abline(v = obs_f[1])
hist(lightDark_rand_f)
abline(v = obs_f[2])
hist(interaction_rand_f)
abline(v=obs_f[3])
P_value_taxa<-(sum(taxa_rand_f>obs_f[1])+sum(taxa_rand_f<-obs_f[1]))/10000
P_value_lightDark<-(sum(lightDark_rand_f>obs_f[2])+sum(lightDark_rand_f<-obs_f[2]))/10000
P_value_interaction<-sum(interaction_rand_f>obs_f[3]+sum(interaction_rand_f<-obs_f[3]))/10000

```


